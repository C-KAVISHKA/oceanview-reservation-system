<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Reservations - OceanView Resort</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="page-app">
    <!-- Top Navigation -->
    <nav class="topbar">
        <a href="dashboard.html" class="topbar-brand">
            <span class="brand-icon">ğŸŒŠ</span>
            <div>
                <h1>OceanView Resort</h1>
                <span class="brand-sub">Reservation System</span>
            </div>
        </a>
        <div class="topbar-nav">
            <a href="dashboard.html">ğŸ  Dashboard</a>
            <a href="new-reservation.html">â• New Booking</a>
            <a href="view-reservation.html" class="active">ğŸ“‹ Reservations</a>
            <a href="billing.html">ğŸ’³ Billing</a>
            <a href="reports.html">ğŸ“Š Reports</a>
            <a href="help.html">â“ Help</a>
        </div>
        <div class="topbar-right">
            <button class="btn btn-outline btn-sm" onclick="sessionStorage.clear(); window.location.href='login.html'">ğŸšª Logout</button>
        </div>
    </nav>

    <!-- Page Banner -->
    <div class="page-banner">
        <div class="page-banner-content">
            <div class="page-banner-icon">ğŸ“‹</div>
            <div>
                <h1 class="page-banner-title">Reservations</h1>
                <p class="page-banner-sub">Search and manage all guest reservations</p>
            </div>
        </div>
        <div class="page-banner-wave"></div>
    </div>

    <div class="page-content">

        <!-- Quick Stats Strip -->
        <div class="res-quick-stats" id="quickStats">
            <div class="res-qs-item res-qs--total">
                <span class="res-qs-num" id="qsTotal">-</span>
                <span class="res-qs-label">Total</span>
            </div>
            <div class="res-qs-item res-qs--confirmed">
                <span class="res-qs-num" id="qsConfirmed">-</span>
                <span class="res-qs-label">Confirmed</span>
            </div>
            <div class="res-qs-item res-qs--pending">
                <span class="res-qs-num" id="qsPending">-</span>
                <span class="res-qs-label">Pending</span>
            </div>
            <div class="res-qs-item res-qs--cancelled">
                <span class="res-qs-num" id="qsCancelled">-</span>
                <span class="res-qs-label">Cancelled</span>
            </div>
        </div>

        <!-- Search & Filter Bar -->
        <div class="card" style="margin-bottom: 20px; padding: 18px 24px;">
            <div class="res-toolbar">
                <div class="res-search-wrap">
                    <span class="res-search-icon">ğŸ”</span>
                    <input type="text" id="searchInput" class="res-search-input" placeholder="Search by guest name, email, or reservation ID...">
                </div>
                <div class="res-filter-tabs">
                    <button class="res-filter-tab active" data-filter="ALL">All</button>
                    <button class="res-filter-tab" data-filter="PENDING">Pending</button>
                    <button class="res-filter-tab" data-filter="CONFIRMED">Confirmed</button>
                    <button class="res-filter-tab" data-filter="CANCELLED">Cancelled</button>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="card card-elevated">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0; font-size: 1.05rem; color: var(--ocean-deep);">ğŸ“‹ All Reservations</h2>
                <span id="reservationCount" class="dash-section-badge">Loading...</span>
            </div>
            
            <div id="loadingMessage" style="text-align: center; padding: 50px; color: var(--gray-500);">
                <div class="spinner"></div>
                <p style="margin-top: 14px;">Loading reservations...</p>
            </div>

            <div id="errorMessage" class="enhanced-alert enhanced-alert--error" style="display: none;">
                <span class="enhanced-alert-icon">âš ï¸</span>
                <div class="enhanced-alert-body"><strong>Error</strong><p id="errorText"></p></div>
            </div>

            <div class="table-wrapper">
                <table id="reservationsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Guest Name</th>
                            <th>Email</th>
                            <th>Room</th>
                            <th>Check-In</th>
                            <th>Check-Out</th>
                            <th>Guests</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsBody"></tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" style="display: none; text-align: center; padding: 60px 30px;">
                <div style="font-size: 3.5rem; margin-bottom: 12px; animation: float 3s ease-in-out infinite;">ğŸ“­</div>
                <h3 style="color: var(--ocean-deep); margin-bottom: 6px;">No Reservations Found</h3>
                <p style="color: var(--gray-500); margin-bottom: 20px;">Try adjusting your search or filter criteria</p>
                <button class="btn btn-secondary btn-sm" onclick="resetFilters()">Reset Filters</button>
            </div>
        </div>

        <div class="page-footer">
            &copy; 2026 OceanView Resort, Galle &mdash; All Rights Reserved
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“„ Reservation Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let allReservations = [];
        let currentFilter = 'ALL';

        async function loadReservations() {
            try {
                const reservations = await API.get('/reservations');
                allReservations = reservations;

                // Quick stats
                document.getElementById('qsTotal').textContent = reservations.length;
                document.getElementById('qsConfirmed').textContent = reservations.filter(r => r.status === 'CONFIRMED').length;
                document.getElementById('qsPending').textContent = reservations.filter(r => r.status === 'PENDING').length;
                document.getElementById('qsCancelled').textContent = reservations.filter(r => r.status === 'CANCELLED').length;

                applyFilters();
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('reservationsTable').style.display = 'table';
            } catch (error) {
                console.error('Error loading reservations:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorText').textContent = error.message;
                document.getElementById('errorMessage').style.display = 'flex';
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allReservations;

            if (currentFilter !== 'ALL') {
                filtered = filtered.filter(r => r.status === currentFilter);
            }
            if (searchTerm) {
                filtered = filtered.filter(r =>
                    r.guestFullName.toLowerCase().includes(searchTerm) ||
                    r.email.toLowerCase().includes(searchTerm) ||
                    r.id.toString().includes(searchTerm)
                );
            }

            displayReservations(filtered);
            document.getElementById('reservationCount').textContent = filtered.length + ' found';
            document.getElementById('emptyState').style.display = filtered.length === 0 ? 'block' : 'none';
            document.getElementById('reservationsTable').style.display = filtered.length > 0 ? 'table' : 'none';
        }

        function displayReservations(reservations) {
            const tbody = document.getElementById('reservationsBody');
            tbody.innerHTML = '';

            reservations.forEach((reservation, i) => {
                const row = document.createElement('tr');
                row.style.animation = `fadeInUp 0.35s ease-out both`;
                row.style.animationDelay = `${i * 0.04}s`;
                row.innerHTML = `
                    <td><strong>#${reservation.id}</strong></td>
                    <td>${reservation.guestFullName}</td>
                    <td>${reservation.email}</td>
                    <td><span class="dash-room-tag">${reservation.roomType}</span></td>
                    <td>${reservation.checkIn}</td>
                    <td>${reservation.checkOut}</td>
                    <td>${reservation.numberOfGuests}</td>
                    <td><span class="status-badge status-${reservation.status}">${reservation.status}</span></td>
                    <td class="action-cell">
                        <button class="action-btn btn-view" onclick="viewDetails(${reservation.id})">ğŸ‘ï¸ View</button>
                        <button class="action-btn btn-delete" onclick="deleteReservation(${reservation.id})">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        // Filter tabs
        document.querySelectorAll('.res-filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.res-filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                applyFilters();
            });
        });

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            currentFilter = 'ALL';
            document.querySelectorAll('.res-filter-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.res-filter-tab[data-filter="ALL"]').classList.add('active');
            applyFilters();
        }

        async function viewDetails(id) {
            try {
                const reservation = await API.get('/reservations/' + id);
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="modal-detail-grid">
                        <div class="detail-row"><div class="detail-label">Reservation ID</div><div class="detail-value"><strong>#${reservation.id}</strong></div></div>
                        <div class="detail-row"><div class="detail-label">Guest Name</div><div class="detail-value">${reservation.guestFullName}</div></div>
                        <div class="detail-row"><div class="detail-label">Email</div><div class="detail-value">${reservation.email}</div></div>
                        <div class="detail-row"><div class="detail-label">Contact</div><div class="detail-value">${reservation.contactNumber}</div></div>
                        <div class="detail-row"><div class="detail-label">Address</div><div class="detail-value">${reservation.address}</div></div>
                        <div class="detail-row"><div class="detail-label">Room Type</div><div class="detail-value"><span class="dash-room-tag">${reservation.roomType}</span></div></div>
                        <div class="detail-row"><div class="detail-label">Check-In</div><div class="detail-value">${reservation.checkIn}</div></div>
                        <div class="detail-row"><div class="detail-label">Check-Out</div><div class="detail-value">${reservation.checkOut}</div></div>
                        <div class="detail-row"><div class="detail-label">Guests</div><div class="detail-value">${reservation.numberOfGuests}</div></div>
                        <div class="detail-row"><div class="detail-label">Status</div><div class="detail-value"><span class="status-badge status-${reservation.status}">${reservation.status}</span></div></div>
                        ${reservation.specialRequests ? '<div class="detail-row"><div class="detail-label">Special Requests</div><div class="detail-value">' + reservation.specialRequests + '</div></div>' : ''}
                        <div class="detail-row"><div class="detail-label">Created</div><div class="detail-value">${new Date(reservation.createdAt).toLocaleString()}</div></div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-gold" onclick="window.location.href='billing.html?id=${reservation.id}'" style="flex: 1;">ğŸ’³ View Bill</button>
                        <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Close</button>
                    </div>
                `;
                document.getElementById('detailModal').style.display = 'block';
            } catch (error) {
                alert('Error loading reservation details: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        async function deleteReservation(id) {
            if (!confirm('Are you sure you want to delete reservation #' + id + '?')) return;
            try {
                await API.delete('/reservations/' + id);
                loadReservations();
            } catch (error) {
                alert('Error deleting reservation: ' + error.message);
            }
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById('detailModal')) closeModal();
        }

        loadReservations();
    </script>
</body>
</html>
