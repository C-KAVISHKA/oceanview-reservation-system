<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - OceanView Resort</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="page-app">
    <!-- Top Navigation -->
    <nav class="topbar">
        <a href="dashboard.html" class="topbar-brand">
            <span class="brand-icon">üåä</span>
            <div>
                <h1>OceanView Resort</h1>
                <span class="brand-sub">Reservation System</span>
            </div>
        </a>
        <div class="topbar-nav">
            <a href="dashboard.html" class="active">üè† Dashboard</a>
            <a href="new-reservation.html">‚ûï New Booking</a>
            <a href="view-reservation.html">üìã Reservations</a>
            <a href="billing.html">üí≥ Billing</a>
            <a href="reports.html">üìä Reports</a>
            <a href="help.html">‚ùì Help</a>
        </div>
        <div class="topbar-right">
            <span class="topbar-user" id="userName">Staff</span>
            <button class="btn btn-outline btn-sm" onclick="logout()">üö™ Logout</button>
        </div>
    </nav>

    <!-- Hero Welcome Banner -->
    <div class="dash-hero">
        <div class="dash-hero-bg">
            <div class="dash-hero-wave"></div>
            <div class="dash-hero-wave dash-hero-wave--2"></div>
        </div>
        <div class="dash-hero-content">
            <div class="dash-hero-left">
                <p class="dash-hero-label" id="greetingLabel">Welcome back</p>
                <h1 class="dash-hero-title" id="greetingText">Good Morning, Staff!</h1>
                <p class="dash-hero-subtitle" id="greetingTime">Loading date...</p>
                <div class="dash-hero-actions">
                    <a href="new-reservation.html" class="btn btn-hero-primary">‚ûï New Booking</a>
                    <a href="view-reservation.html" class="btn btn-hero-secondary">üìã View All</a>
                </div>
            </div>
            <div class="dash-hero-right">
                <div class="dash-clock-widget">
                    <div class="dash-clock-time" id="liveClock">--:--</div>
                    <div class="dash-clock-label" id="liveClockLabel">Current Time</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="page-content">

        <!-- Quick Stats Row -->
        <div class="dash-section-header">
            <h2 class="dash-section-title"><span class="dash-section-icon">üìà</span> Overview</h2>
            <span class="dash-section-badge" id="lastUpdated">Live</span>
        </div>
        <div class="dash-stats-grid">
            <div class="dash-stat-card dash-stat--ocean">
                <div class="dash-stat-icon-wrap"><span>üìä</span></div>
                <div class="dash-stat-info">
                    <span class="dash-stat-label">Total Reservations</span>
                    <span class="dash-stat-value" id="totalReservations">-</span>
                </div>
                <div class="dash-stat-trend" id="totalTrend"></div>
            </div>
            <div class="dash-stat-card dash-stat--green">
                <div class="dash-stat-icon-wrap"><span>‚úÖ</span></div>
                <div class="dash-stat-info">
                    <span class="dash-stat-label">Confirmed</span>
                    <span class="dash-stat-value" id="confirmedReservations">-</span>
                </div>
                <div class="dash-stat-bar">
                    <div class="dash-stat-bar-fill dash-bar--green" id="confirmedBar" style="width: 0%;"></div>
                </div>
            </div>
            <div class="dash-stat-card dash-stat--amber">
                <div class="dash-stat-icon-wrap"><span>‚è≥</span></div>
                <div class="dash-stat-info">
                    <span class="dash-stat-label">Pending</span>
                    <span class="dash-stat-value" id="pendingReservations">-</span>
                </div>
                <div class="dash-stat-bar">
                    <div class="dash-stat-bar-fill dash-bar--amber" id="pendingBar" style="width: 0%;"></div>
                </div>
            </div>
            <div class="dash-stat-card dash-stat--coral">
                <div class="dash-stat-icon-wrap"><span>üõ¨</span></div>
                <div class="dash-stat-info">
                    <span class="dash-stat-label">Today's Check-ins</span>
                    <span class="dash-stat-value" id="todayCheckIns">-</span>
                </div>
                <div class="dash-stat-trend" id="checkinTrend"></div>
            </div>
        </div>

        <!-- Room Occupancy Mini Cards -->
        <div class="dash-section-header" style="margin-top: 36px;">
            <h2 class="dash-section-title"><span class="dash-section-icon">üè®</span> Room Availability</h2>
        </div>
        <div class="dash-room-grid">
            <div class="dash-room-card">
                <div class="dash-room-type">Single</div>
                <div class="dash-room-price">LKR 30,000</div>
                <div class="dash-room-occ">
                    <div class="dash-room-occ-bar"><div class="dash-room-occ-fill" id="occSingle" style="width:0%"></div></div>
                    <span class="dash-room-occ-text" id="occSingleText">-</span>
                </div>
            </div>
            <div class="dash-room-card">
                <div class="dash-room-type">Double</div>
                <div class="dash-room-price">LKR 45,000</div>
                <div class="dash-room-occ">
                    <div class="dash-room-occ-bar"><div class="dash-room-occ-fill" id="occDouble" style="width:0%"></div></div>
                    <span class="dash-room-occ-text" id="occDoubleText">-</span>
                </div>
            </div>
            <div class="dash-room-card">
                <div class="dash-room-type">Suite</div>
                <div class="dash-room-price">LKR 75,000</div>
                <div class="dash-room-occ">
                    <div class="dash-room-occ-bar"><div class="dash-room-occ-fill" id="occSuite" style="width:0%"></div></div>
                    <span class="dash-room-occ-text" id="occSuiteText">-</span>
                </div>
            </div>
            <div class="dash-room-card">
                <div class="dash-room-type">Deluxe</div>
                <div class="dash-room-price">LKR 120,000</div>
                <div class="dash-room-occ">
                    <div class="dash-room-occ-bar"><div class="dash-room-occ-fill" id="occDeluxe" style="width:0%"></div></div>
                    <span class="dash-room-occ-text" id="occDeluxeText">-</span>
                </div>
            </div>
        </div>

        <!-- Quick Navigation Cards -->
        <div class="dash-section-header" style="margin-top: 36px;">
            <h2 class="dash-section-title"><span class="dash-section-icon">‚ö°</span> Quick Actions</h2>
        </div>
        <div class="nav-grid">
            <a href="new-reservation.html" class="nav-card">
                <span class="icon">üèñÔ∏è</span>
                <h2>New Reservation</h2>
                <p>Create a new room reservation for a guest</p>
            </a>
            <a href="view-reservation.html" class="nav-card">
                <span class="icon">üìã</span>
                <h2>View Reservations</h2>
                <p>Search and manage all reservations</p>
            </a>
            <a href="billing.html" class="nav-card">
                <span class="icon">üí≥</span>
                <h2>Billing & Invoices</h2>
                <p>Generate bills and print invoices</p>
            </a>
            <a href="reports.html" class="nav-card">
                <span class="icon">üìä</span>
                <h2>Reports</h2>
                <p>View occupancy and revenue analytics</p>
            </a>
            <a href="help.html" class="nav-card">
                <span class="icon">üìñ</span>
                <h2>Help & Guide</h2>
                <p>System documentation for staff</p>
            </a>
        </div>

        <!-- Recent Reservations -->
        <div class="dash-section-header" style="margin-top: 36px;">
            <h2 class="dash-section-title"><span class="dash-section-icon">üïê</span> Recent Reservations</h2>
            <a href="view-reservation.html" class="dash-section-link">View all ‚Üí</a>
        </div>
        <div class="card card-elevated" style="padding: var(--space-lg);">
            <div id="recentLoading" style="text-align: center; padding: 30px; color: var(--gray-500);">
                <div class="spinner"></div>
                <p style="margin-top: 12px;">Loading recent reservations...</p>
            </div>
            <div class="table-wrapper">
                <table id="recentTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Guest</th>
                            <th>Room</th>
                            <th>Check-In</th>
                            <th>Check-Out</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="recentBody"></tbody>
                </table>
            </div>
            <div id="noRecentMsg" style="display: none; text-align: center; padding: 48px 30px;">
                <div style="font-size: 3.5rem; margin-bottom: 12px; animation: float 3s ease-in-out infinite;">üèùÔ∏è</div>
                <h3 style="color: var(--ocean-deep); margin-bottom: 6px;">No Reservations Yet</h3>
                <p style="color: var(--gray-500); margin-bottom: 20px;">Start managing your resort by creating the first booking</p>
                <a href="new-reservation.html" class="btn btn-primary" style="width: auto; padding: 12px 32px;">‚ûï Create First Reservation</a>
            </div>
        </div>

        <div class="page-footer">
            &copy; 2026 OceanView Resort, Galle &mdash; All Rights Reserved
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const userName = sessionStorage.getItem('userName') || sessionStorage.getItem('userEmail') || 'Staff';
        document.getElementById('userName').textContent = userName;

        // Time-based greeting
        const hour = new Date().getHours();
        let greeting = 'Good Evening';
        let emoji = 'üåô';
        let label = 'Welcome back';
        if (hour < 12) { greeting = 'Good Morning'; emoji = '‚òÄÔ∏è'; label = 'Rise & shine'; }
        else if (hour < 17) { greeting = 'Good Afternoon'; emoji = 'üå§Ô∏è'; label = 'Welcome back'; }
        else { label = 'Still going strong'; }

        document.getElementById('greetingText').textContent = `${emoji} ${greeting}, ${userName}!`;
        document.getElementById('greetingLabel').textContent = label;
        document.getElementById('greetingTime').textContent = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Live clock
        function updateClock() {
            const now = new Date();
            const h = now.getHours();
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            document.getElementById('liveClock').textContent = `${h12}:${m}:${s}`;
            document.getElementById('liveClockLabel').textContent = ampm + ' ¬∑ Sri Lanka Time';
        }
        updateClock();
        setInterval(updateClock, 1000);

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        function animateValue(el, end, duration) {
            const start = 0;
            const range = end - start;
            let startTime = null;
            function step(ts) {
                if (!startTime) startTime = ts;
                const progress = Math.min((ts - startTime) / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.floor(eased * range + start);
                if (progress < 1) requestAnimationFrame(step);
            }
            if (end > 0) requestAnimationFrame(step);
            else el.textContent = '0';
        }

        async function loadStats() {
            try {
                const reservations = await API.get('/reservations');
                const total = reservations.length;
                const confirmed = reservations.filter(r => r.status === 'CONFIRMED').length;
                const pending = reservations.filter(r => r.status === 'PENDING').length;
                const cancelled = reservations.filter(r => r.status === 'CANCELLED').length;
                const today = new Date().toISOString().split('T')[0];
                const todayCheckIns = reservations.filter(r => r.checkIn === today).length;

                // Animate numbers
                animateValue(document.getElementById('totalReservations'), total, 800);
                animateValue(document.getElementById('confirmedReservations'), confirmed, 800);
                animateValue(document.getElementById('pendingReservations'), pending, 800);
                animateValue(document.getElementById('todayCheckIns'), todayCheckIns, 800);

                // Progress bars
                if (total > 0) {
                    document.getElementById('confirmedBar').style.width = ((confirmed / total) * 100) + '%';
                    document.getElementById('pendingBar').style.width = ((pending / total) * 100) + '%';
                }

                // Trend badges
                document.getElementById('totalTrend').innerHTML = `<span class="dash-trend-badge dash-trend--up">${total} total</span>`;
                document.getElementById('checkinTrend').innerHTML = todayCheckIns > 0 
                    ? `<span class="dash-trend-badge dash-trend--up">${todayCheckIns} today</span>` 
                    : `<span class="dash-trend-badge dash-trend--neutral">None today</span>`;

                // Room occupancy (capacity: SINGLE=25, DOUBLE=40, SUITE=25, DELUXE=10)
                const active = reservations.filter(r => today >= r.checkIn && today < r.checkOut && r.status !== 'CANCELLED');
                const roomCap = { SINGLE: 25, DOUBLE: 40, SUITE: 25, DELUXE: 10 };
                ['SINGLE','DOUBLE','SUITE','DELUXE'].forEach(type => {
                    const occ = active.filter(r => r.roomType === type).length;
                    const cap = roomCap[type];
                    const pct = Math.min((occ / cap) * 100, 100);
                    const avail = cap - occ;
                    document.getElementById('occ' + type.charAt(0) + type.slice(1).toLowerCase()).style.width = pct + '%';
                    document.getElementById('occ' + type.charAt(0) + type.slice(1).toLowerCase() + 'Text').textContent = avail + ' / ' + cap + ' available';
                });

                // Last updated
                document.getElementById('lastUpdated').textContent = '‚úì Live ¬∑ ' + new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                // Recent reservations (last 5)
                const sorted = [...reservations].sort((a, b) => b.id - a.id);
                const recent = sorted.slice(0, 5);

                document.getElementById('recentLoading').style.display = 'none';

                if (recent.length === 0) {
                    document.getElementById('noRecentMsg').style.display = 'block';
                } else {
                    const tbody = document.getElementById('recentBody');
                    tbody.innerHTML = recent.map((r, i) => `
                        <tr style="animation: fadeInUp 0.4s ease-out both; animation-delay: ${i * 0.06}s;">
                            <td><strong>#${r.id}</strong></td>
                            <td>${r.guestFullName}</td>
                            <td><span class="dash-room-tag">${r.roomType}</span></td>
                            <td>${r.checkIn}</td>
                            <td>${r.checkOut}</td>
                            <td><span class="status-badge status-${r.status}">${r.status}</span></td>
                            <td><button class="action-btn btn-view" onclick="window.location.href='billing.html?id=${r.id}'">View Bill</button></td>
                        </tr>
                    `).join('');
                    document.getElementById('recentTable').style.display = 'table';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('recentLoading').innerHTML = `
                    <div style="padding: 20px;">
                        <span style="font-size: 2rem;">‚ö†Ô∏è</span>
                        <p style="color: var(--sunset-coral); margin-top: 8px;">Could not load data. Please check your connection.</p>
                        <button class="btn btn-sm btn-secondary" onclick="loadStats()" style="margin-top: 12px;">Retry</button>
                    </div>`;
            }
        }

        loadStats();
    </script>
</body>
</html>
