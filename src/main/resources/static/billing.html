<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing - OceanView Resort</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="page-app">
    <!-- Top Navigation -->
    <nav class="topbar no-print">
        <a href="dashboard.html" class="topbar-brand">
            <span class="brand-icon">üåä</span>
            <div>
                <h1>OceanView Resort</h1>
                <span class="brand-sub">Reservation System</span>
            </div>
        </a>
        <div class="topbar-nav">
            <a href="dashboard.html">üè† Dashboard</a>
            <a href="new-reservation.html">‚ûï New Booking</a>
            <a href="view-reservation.html">üìã Reservations</a>
            <a href="billing.html" class="active">üí≥ Billing</a>
            <a href="reports.html">üìä Reports</a>
            <a href="help.html">‚ùì Help</a>
        </div>
        <div class="topbar-right">
            <button class="btn btn-outline btn-sm" onclick="sessionStorage.clear(); window.location.href='login.html'">üö™ Logout</button>
        </div>
    </nav>

    <!-- Page Banner -->
    <div class="page-banner no-print">
        <div class="page-banner-content">
            <div class="page-banner-icon">üí≥</div>
            <div>
                <h1 class="page-banner-title">Billing & Invoices</h1>
                <p class="page-banner-sub">Generate and print bills for reservations</p>
            </div>
        </div>
        <div class="page-banner-wave"></div>
    </div>

    <div class="page-content" style="max-width: 900px;">

        <!-- Search Section -->
        <div class="card card-elevated no-print" style="margin-bottom: 28px; overflow: hidden;">
            <div class="bill-search-section">
                <div class="bill-search-left">
                    <span class="bill-search-icon">üßæ</span>
                    <div>
                        <h2 style="margin: 0 0 4px 0; font-size: 1.1rem;">Generate Invoice</h2>
                        <p style="margin: 0; color: var(--gray-500); font-size: .85rem;">Enter a reservation ID to generate the bill</p>
                    </div>
                </div>
                <div class="bill-search-right">
                    <div class="bill-search-input-wrap">
                        <span class="bill-search-input-prefix">#</span>
                        <input type="number" id="reservationIdInput" placeholder="Reservation ID" class="bill-search-input">
                    </div>
                    <button class="btn btn-gold" onclick="generateBill()" style="white-space: nowrap;">Generate Bill</button>
                </div>
            </div>
            <div id="searchError" class="enhanced-alert enhanced-alert--error" style="display: none; margin: 16px 24px 24px;">
                <span class="enhanced-alert-icon">‚ö†Ô∏è</span>
                <div class="enhanced-alert-body"><p id="searchErrorText"></p></div>
            </div>
        </div>

        <!-- Bill / Invoice -->
        <div class="card card-elevated" id="billSection" style="display: none; padding: 0; overflow: hidden;">
            <!-- Invoice Header -->
            <div class="invoice-header">
                <div class="invoice-brand">
                    <span style="font-size: 2.4rem;">üåä</span>
                    <div>
                        <h1 style="margin:0; font-size: 1.5rem;">OceanView Resort</h1>
                        <p style="margin: 2px 0 0; font-size: .82rem; opacity: .8;">Beachfront Boulevard, Galle, Sri Lanka</p>
                        <p style="margin: 2px 0 0; font-size: .82rem; opacity: .8;">Phone: (555) 123-4567 &bull; billing@oceanview.com</p>
                    </div>
                </div>
                <div class="invoice-tag">
                    <span class="invoice-tag-label">INVOICE</span>
                    <span class="invoice-tag-id" id="invoiceId"></span>
                </div>
            </div>

            <div style="padding: 32px 40px;">
                <div class="bill-info">
                    <div class="info-section">
                        <h3>üë§ Guest Information</h3>
                        <div id="guestInfo"></div>
                    </div>
                    <div class="info-section">
                        <h3>üóìÔ∏è Reservation Details</h3>
                        <div id="reservationInfo"></div>
                    </div>
                </div>

                <div class="table-wrapper" style="margin-top: 28px;">
                    <table class="charges-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Details</th>
                                <th style="text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="chargesBody"></tbody>
                    </table>
                </div>

                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal</span>
                        <span id="subtotalAmount">LKR 0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Service Charge (5%)</span>
                        <span id="serviceChargeAmount">LKR 0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Tax (8%)</span>
                        <span id="taxAmount">LKR 0.00</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Grand Total</span>
                        <span id="grandTotalAmount">LKR 0.00</span>
                    </div>
                </div>

                <div class="invoice-thankyou">
                    <span style="font-size: 1.5rem;">üåÖ</span>
                    <p style="margin: 8px 0 0; font-weight: 600; color: var(--ocean-deep);">Thank you for choosing OceanView Resort!</p>
                    <p style="margin: 4px 0 0; color: var(--gray-500); font-size: 0.82rem;">Generated on: <span id="billDate"></span></p>
                </div>

                <!-- Action Buttons -->
                <div class="invoice-actions no-print">
                    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Invoice</button>
                    <button class="btn btn-gold" id="confirmBillBtn" onclick="confirmBill()" style="display: none;">‚úÖ Confirm Bill</button>
                </div>
                <div id="confirmedBadge" class="invoice-confirmed-badge" style="display: none;">
                    <span style="font-size: 1.3rem;">‚úÖ</span> Bill Confirmed ‚Äî Reservation Status: CONFIRMED
                </div>
            </div>
        </div>

        <div class="page-footer no-print">
            &copy; 2026 OceanView Resort, Galle &mdash; All Rights Reserved
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const reservationId = urlParams.get('id');
        if (reservationId) {
            document.getElementById('reservationIdInput').value = reservationId;
            generateBill();
        }

        async function generateBill() {
            const reservationId = document.getElementById('reservationIdInput').value;
            const searchError = document.getElementById('searchError');
            const billSection = document.getElementById('billSection');
            
            searchError.style.display = 'none';
            billSection.style.display = 'none';
            
            if (!reservationId) {
                document.getElementById('searchErrorText').textContent = 'Please enter a reservation ID';
                searchError.style.display = 'flex';
                return;
            }
            
            try {
                const reservation = await API.get('/reservations/' + reservationId);
                const billing = await API.get('/billing/' + reservationId);

                // Invoice ID
                document.getElementById('invoiceId').textContent = '#INV-' + String(reservation.id).padStart(5, '0');
                
                document.getElementById('guestInfo').innerHTML = `
                    <div class="info-row"><span class="info-label">Name</span><span class="info-value">${reservation.guestFullName}</span></div>
                    <div class="info-row"><span class="info-label">Email</span><span class="info-value">${reservation.email}</span></div>
                    <div class="info-row"><span class="info-label">Contact</span><span class="info-value">${reservation.contactNumber}</span></div>
                    <div class="info-row"><span class="info-label">Address</span><span class="info-value">${reservation.address}</span></div>
                `;
                
                const checkIn = new Date(reservation.checkIn);
                const checkOut = new Date(reservation.checkOut);
                const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                
                document.getElementById('reservationInfo').innerHTML = `
                    <div class="info-row"><span class="info-label">Reservation ID</span><span class="info-value"><strong>#${reservation.id}</strong></span></div>
                    <div class="info-row"><span class="info-label">Room Type</span><span class="info-value"><span class="dash-room-tag">${reservation.roomType}</span></span></div>
                    <div class="info-row"><span class="info-label">Check-In</span><span class="info-value">${reservation.checkIn}</span></div>
                    <div class="info-row"><span class="info-label">Check-Out</span><span class="info-value">${reservation.checkOut}</span></div>
                    <div class="info-row"><span class="info-label">Nights</span><span class="info-value">${nights}</span></div>
                    <div class="info-row"><span class="info-label">Guests</span><span class="info-value">${reservation.numberOfGuests}</span></div>
                `;
                
                const roomRates = { 'SINGLE': 30000, 'DOUBLE': 45000, 'SUITE': 75000, 'DELUXE': 120000 };
                const ratePerNight = roomRates[reservation.roomType] || 0;
                const roomSubtotal = ratePerNight * nights;
                
                document.getElementById('chargesBody').innerHTML = `
                    <tr>
                        <td>Room Charges</td>
                        <td>${reservation.roomType} &mdash; ${nights} night(s) √ó LKR ${ratePerNight.toLocaleString()}</td>
                        <td style="text-align: right;">LKR ${roomSubtotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    </tr>
                `;
                
                const serviceCharge = roomSubtotal * 0.05;
                const tax = roomSubtotal * 0.08;
                const grandTotal = roomSubtotal + serviceCharge + tax;
                
                document.getElementById('subtotalAmount').textContent = 'LKR ' + roomSubtotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('serviceChargeAmount').textContent = 'LKR ' + serviceCharge.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('taxAmount').textContent = 'LKR ' + tax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('grandTotalAmount').textContent = 'LKR ' + grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('billDate').textContent = new Date().toLocaleString();
                
                const confirmBtn = document.getElementById('confirmBillBtn');
                const confirmedBadge = document.getElementById('confirmedBadge');
                if (reservation.status === 'CONFIRMED') {
                    confirmBtn.style.display = 'none';
                    confirmedBadge.style.display = 'flex';
                } else {
                    confirmBtn.style.display = 'inline-block';
                    confirmedBadge.style.display = 'none';
                }
                
                window.currentReservationId = reservation.id;
                
                billSection.style.display = 'block';
                billSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('Error generating bill:', error);
                document.getElementById('searchErrorText').textContent = error.message || 'Could not generate bill. Please check the reservation ID.';
                searchError.style.display = 'flex';
            }
        }

        document.getElementById('reservationIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') generateBill();
        });

        async function confirmBill() {
            if (!window.currentReservationId) return;
            if (!confirm('Are you sure you want to confirm this bill?')) return;
            
            try {
                await API.patch('/reservations/' + window.currentReservationId + '/status', { status: 'CONFIRMED' });
                document.getElementById('confirmBillBtn').style.display = 'none';
                document.getElementById('confirmedBadge').style.display = 'flex';
            } catch (error) {
                console.error('Error confirming bill:', error);
                alert('Error confirming bill: ' + (error.message || 'Something went wrong'));
            }
        }
    </script>
</body>
</html>
