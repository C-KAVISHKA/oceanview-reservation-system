<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Reservation - OceanView Resort</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="page-app">
    <!-- Top Navigation -->
    <nav class="topbar">
        <a href="dashboard.html" class="topbar-brand">
            <span class="brand-icon">üåä</span>
            <div>
                <h1>OceanView Resort</h1>
                <span class="brand-sub">Reservation System</span>
            </div>
        </a>
        <div class="topbar-nav">
            <a href="dashboard.html">üè† Dashboard</a>
            <a href="new-reservation.html" class="active">‚ûï New Booking</a>
            <a href="view-reservation.html">üìã Reservations</a>
            <a href="billing.html">üí≥ Billing</a>
            <a href="reports.html">üìä Reports</a>
            <a href="help.html">‚ùì Help</a>
        </div>
        <div class="topbar-right">
            <button class="btn btn-outline btn-sm" onclick="sessionStorage.clear(); window.location.href='login.html'">üö™ Logout</button>
        </div>
    </nav>

    <!-- Page Banner -->
    <div class="page-banner">
        <div class="page-banner-content">
            <div class="page-banner-icon">üèñÔ∏è</div>
            <div>
                <h1 class="page-banner-title">New Reservation</h1>
                <p class="page-banner-sub">Create a new room booking for a guest</p>
            </div>
        </div>
        <div class="page-banner-wave"></div>
    </div>

    <div class="page-content" style="max-width: 800px;">

        <!-- Progress Steps -->
        <div class="form-steps">
            <div class="form-step active" id="step1Indicator">
                <span class="form-step-num">1</span>
                <span class="form-step-label">Guest Info</span>
            </div>
            <div class="form-step-line"></div>
            <div class="form-step" id="step2Indicator">
                <span class="form-step-num">2</span>
                <span class="form-step-label">Stay Details</span>
            </div>
            <div class="form-step-line"></div>
            <div class="form-step" id="step3Indicator">
                <span class="form-step-num">3</span>
                <span class="form-step-label">Confirm</span>
            </div>
        </div>

        <!-- Success / Error Messages -->
        <div id="successMessage" class="enhanced-alert enhanced-alert--success" style="display: none;">
            <span class="enhanced-alert-icon">‚úÖ</span>
            <div class="enhanced-alert-body">
                <strong>Booking Created!</strong>
                <p id="successText"></p>
            </div>
            <a href="view-reservation.html" class="enhanced-alert-action">View All ‚Üí</a>
        </div>
        <div id="errorMessage" class="enhanced-alert enhanced-alert--error" style="display: none;">
            <span class="enhanced-alert-icon">‚ö†Ô∏è</span>
            <div class="enhanced-alert-body">
                <strong>Error</strong>
                <p id="errorText"></p>
            </div>
        </div>

        <div class="card card-elevated" style="padding: 0; overflow: hidden;">
            <form id="reservationForm">
                <!-- Section 1: Guest Info -->
                <div class="form-card-section">
                    <div class="form-card-section-header">
                        <span class="form-card-section-icon">üë§</span>
                        <div>
                            <h3>Guest Information</h3>
                            <p>Enter the guest's personal details</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="guestFullName">Full Name <span class="required-star">*</span></label>
                        <input type="text" id="guestFullName" name="guestFullName" required 
                               minlength="2" maxlength="100" placeholder="e.g. John Smith">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email Address <span class="required-star">*</span></label>
                        <input type="email" id="email" name="email" required 
                               maxlength="100" placeholder="e.g. john.smith@example.com">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactNumber">Contact Number <span class="required-star">*</span></label>
                            <input type="tel" id="contactNumber" name="contactNumber" required 
                                   pattern="^\+?[0-9\-\s()]{7,20}$" placeholder="+94-77-123-4567">
                            <small>Format: +94-77-123-4567 or (077) 123-4567</small>
                        </div>
                        <div class="form-group">
                            <label for="numberOfGuests">Number of Guests <span class="required-star">*</span></label>
                            <input type="number" id="numberOfGuests" name="numberOfGuests" 
                                   required min="1" max="10" value="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Address <span class="required-star">*</span></label>
                        <input type="text" id="address" name="address" required 
                               maxlength="255" placeholder="e.g. 123 Main Street, Colombo, Sri Lanka">
                    </div>
                </div>

                <!-- Section 2: Stay Details -->
                <div class="form-card-section">
                    <div class="form-card-section-header">
                        <span class="form-card-section-icon">üóìÔ∏è</span>
                        <div>
                            <h3>Stay Details</h3>
                            <p>Select dates and room preference</p>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="checkIn">Check-In Date <span class="required-star">*</span></label>
                            <input type="date" id="checkIn" name="checkIn" required>
                        </div>
                        <div class="form-group">
                            <label for="checkOut">Check-Out Date <span class="required-star">*</span></label>
                            <input type="date" id="checkOut" name="checkOut" required>
                        </div>
                    </div>

                    <!-- Stay Summary -->
                    <div class="stay-summary" id="staySummary" style="display: none;">
                        <span class="stay-summary-icon">üåô</span>
                        <span id="nightCount">0</span> night(s) &bull; 
                        <span id="dateRange"></span>
                    </div>
                    
                    <div class="form-group">
                        <label>Room Type <span class="required-star">*</span></label>
                        <div class="room-picker" id="roomPicker">
                            <label class="room-pick-card" data-value="SINGLE">
                                <input type="radio" name="roomType" value="SINGLE" required>
                                <div class="room-pick-inner">
                                    <span class="room-pick-icon">üõèÔ∏è</span>
                                    <span class="room-pick-name">Single</span>
                                    <span class="room-pick-price">LKR 30,000<small>/night</small></span>
                                </div>
                                <div class="room-pick-check">‚úì</div>
                            </label>
                            <label class="room-pick-card" data-value="DOUBLE">
                                <input type="radio" name="roomType" value="DOUBLE">
                                <div class="room-pick-inner">
                                    <span class="room-pick-icon">üõèÔ∏èüõèÔ∏è</span>
                                    <span class="room-pick-name">Double</span>
                                    <span class="room-pick-price">LKR 45,000<small>/night</small></span>
                                </div>
                                <div class="room-pick-check">‚úì</div>
                            </label>
                            <label class="room-pick-card" data-value="SUITE">
                                <input type="radio" name="roomType" value="SUITE">
                                <div class="room-pick-inner">
                                    <span class="room-pick-icon">üè®</span>
                                    <span class="room-pick-name">Suite</span>
                                    <span class="room-pick-price">LKR 75,000<small>/night</small></span>
                                </div>
                                <div class="room-pick-check">‚úì</div>
                            </label>
                            <label class="room-pick-card" data-value="DELUXE">
                                <input type="radio" name="roomType" value="DELUXE">
                                <div class="room-pick-inner">
                                    <span class="room-pick-icon">üëë</span>
                                    <span class="room-pick-name">Deluxe</span>
                                    <span class="room-pick-price">LKR 120,000<small>/night</small></span>
                                </div>
                                <div class="room-pick-check">‚úì</div>
                            </label>
                        </div>
                    </div>

                    <!-- Cost Preview -->
                    <div class="cost-preview" id="costPreview" style="display: none;">
                        <div class="cost-preview-label">Estimated Total</div>
                        <div class="cost-preview-value" id="costPreviewValue">LKR 0</div>
                        <div class="cost-preview-detail" id="costPreviewDetail"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialRequests">Special Requests <span style="color: var(--gray-400); font-weight: 400;">(Optional)</span></label>
                        <textarea id="specialRequests" name="specialRequests" maxlength="500"
                                  placeholder="Any special requests or requirements..."></textarea>
                        <small><span id="charCount">0</span> / 500 characters</small>
                    </div>
                </div>
                
                <!-- Submit -->
                <div class="form-card-section" style="border-top: none; padding-top: 0;">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <span id="submitBtnText">üèñÔ∏è Create Reservation</span>
                        <span id="submitBtnLoading" style="display: none;">
                            <span class="spinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></span>
                            Creating...
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <div class="page-footer">
            &copy; 2026 OceanView Resort, Galle &mdash; All Rights Reserved
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const reservationForm = document.getElementById('reservationForm');
        const checkInInput = document.getElementById('checkIn');
        const checkOutInput = document.getElementById('checkOut');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        const today = new Date().toISOString().split('T')[0];
        checkInInput.min = today;
        checkOutInput.min = today;

        checkInInput.addEventListener('change', function() {
            checkOutInput.min = this.value;
            if (checkOutInput.value && checkOutInput.value <= this.value) {
                checkOutInput.value = '';
            }
            updateStaySummary();
        });
        checkOutInput.addEventListener('change', updateStaySummary);

        // Stay summary (night count)
        function updateStaySummary() {
            const ci = checkInInput.value;
            const co = checkOutInput.value;
            const summary = document.getElementById('staySummary');
            if (ci && co && new Date(co) > new Date(ci)) {
                const nights = Math.ceil((new Date(co) - new Date(ci)) / 86400000);
                document.getElementById('nightCount').textContent = nights;
                const opts = { month: 'short', day: 'numeric' };
                document.getElementById('dateRange').textContent =
                    new Date(ci + 'T00:00').toLocaleDateString('en-US', opts) + ' ‚Üí ' +
                    new Date(co + 'T00:00').toLocaleDateString('en-US', opts);
                summary.style.display = 'flex';
            } else {
                summary.style.display = 'none';
            }
            updateCostPreview();
        }

        // Room picker visual
        document.querySelectorAll('.room-pick-card input').forEach(r => {
            r.addEventListener('change', () => {
                document.querySelectorAll('.room-pick-card').forEach(c => c.classList.remove('selected'));
                r.closest('.room-pick-card').classList.add('selected');
                updateCostPreview();
            });
        });

        // Cost preview
        const rates = { SINGLE: 30000, DOUBLE: 45000, SUITE: 75000, DELUXE: 120000 };
        function updateCostPreview() {
            const ci = checkInInput.value, co = checkOutInput.value;
            const sel = document.querySelector('input[name="roomType"]:checked');
            const preview = document.getElementById('costPreview');
            if (ci && co && sel && new Date(co) > new Date(ci)) {
                const nights = Math.ceil((new Date(co) - new Date(ci)) / 86400000);
                const rate = rates[sel.value];
                const sub = rate * nights;
                const total = sub + sub * 0.05 + sub * 0.08;
                document.getElementById('costPreviewValue').textContent = 'LKR ' + total.toLocaleString('en-US', {minimumFractionDigits:2});
                document.getElementById('costPreviewDetail').textContent = nights + ' night(s) √ó LKR ' + rate.toLocaleString() + ' + 13% taxes';
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // Character counter for special requests
        document.getElementById('specialRequests').addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length;
        });

        // Step indicators
        const guestFields = ['guestFullName','email','contactNumber','address'];
        const stayFields = ['checkIn','checkOut'];
        function updateSteps() {
            const s1Done = guestFields.every(f => document.getElementById(f).value.trim() !== '');
            const s2Done = stayFields.every(f => document.getElementById(f).value.trim() !== '') && document.querySelector('input[name="roomType"]:checked');
            document.getElementById('step1Indicator').classList.toggle('done', s1Done);
            document.getElementById('step2Indicator').classList.toggle('active', s1Done);
            document.getElementById('step2Indicator').classList.toggle('done', s1Done && s2Done);
            document.getElementById('step3Indicator').classList.toggle('active', s1Done && s2Done);
        }
        reservationForm.addEventListener('input', updateSteps);
        reservationForm.addEventListener('change', updateSteps);

        function showSuccess(message) {
            document.getElementById('successText').textContent = message;
            successMessage.style.display = 'flex';
            errorMessage.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            errorMessage.style.display = 'flex';
            successMessage.style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateDates(checkIn, checkOut) {
            return new Date(checkOut) > new Date(checkIn);
        }

        async function handleSubmit(event) {
            event.preventDefault();
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            const checkIn = checkInInput.value;
            const checkOut = checkOutInput.value;
            
            if (!validateDates(checkIn, checkOut)) {
                showError('Check-out date must be after check-in date');
                return;
            }

            const selectedRoom = document.querySelector('input[name="roomType"]:checked');
            if (!selectedRoom) {
                showError('Please select a room type');
                return;
            }
            
            const payload = {
                guestFullName: document.getElementById('guestFullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                contactNumber: document.getElementById('contactNumber').value.trim(),
                address: document.getElementById('address').value.trim(),
                checkIn: checkIn,
                checkOut: checkOut,
                roomType: selectedRoom.value,
                numberOfGuests: parseInt(document.getElementById('numberOfGuests').value)
            };
            
            const specialRequests = document.getElementById('specialRequests').value.trim();
            if (specialRequests) payload.specialRequests = specialRequests;
            
            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtnText').style.display = 'none';
                document.getElementById('submitBtnLoading').style.display = 'inline';
                
                const response = await API.post('/reservations', payload);
                showSuccess('Reservation #' + response.id + ' created successfully! The guest has been booked.');
                reservationForm.reset();
                document.querySelectorAll('.room-pick-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('staySummary').style.display = 'none';
                document.getElementById('costPreview').style.display = 'none';
                document.getElementById('charCount').textContent = '0';
                updateSteps();
                
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtnText').style.display = 'inline';
                document.getElementById('submitBtnLoading').style.display = 'none';
            } catch (error) {
                console.error('Reservation creation error:', error);
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtnText').style.display = 'inline';
                document.getElementById('submitBtnLoading').style.display = 'none';
                
                if (error.status === 400) {
                    showError('Validation error: ' + error.message);
                } else if (error.message) {
                    showError('Error: ' + error.message);
                } else {
                    showError('Failed to create reservation. Please try again.');
                }
            }
        }

        reservationForm.addEventListener('submit', handleSubmit);
    </script>
</body>
</html>

